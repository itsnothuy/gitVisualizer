# Internationalization (i18n) Guide

This document explains how to add new languages, translate content, and work with the internationalization system in Git Visualizer.

## Overview

Git Visualizer uses [i18next](https://www.i18next.com/) with [react-i18next](https://react.i18next.com/) for internationalization. The system supports:

- Multiple languages with easy switching
- RTL (Right-to-Left) support for languages like Arabic and Hebrew
- Lazy loading of translation files
- Persistent language preferences in localStorage
- Localized tutorial content

## Architecture

### Core Components

1. **i18n Configuration** (`src/lib/i18n/config.ts`)
   - Initializes i18next with HTTP backend
   - Configures language detection
   - Defines supported languages and their properties

2. **I18nProvider** (`src/lib/i18n/I18nProvider.tsx`)
   - React context provider for i18next
   - Manages document direction (LTR/RTL)
   - Handles language initialization

3. **Custom Hooks** (`src/lib/i18n/hooks.ts`)
   - `useTranslation()`: Main translation hook
   - `useLanguage()`: Language management utilities
   - `useLocalizedContent()`: For tutorial level content

4. **Language Switcher** (`src/components/settings/language-switcher.tsx`)
   - UI component for changing languages
   - Displays available languages with native names

## Adding a New Language

### Step 1: Add Language Definition

Edit `src/lib/i18n/config.ts` and add your language to the `languages` object:

```typescript
export const languages = {
  en: { name: 'English', dir: 'ltr' },
  de: { name: 'Deutsch', dir: 'ltr' },
  ar: { name: 'العربية', dir: 'rtl' },
  // Add your language here:
  fr: { name: 'Français', dir: 'ltr' },
  he: { name: 'עברית', dir: 'rtl' },  // Hebrew (RTL)
} as const;
```

**Properties:**
- `name`: Display name in the language's native script
- `dir`: Text direction - `'ltr'` for left-to-right or `'rtl'` for right-to-left

### Step 2: Create Translation File

Create a new JSON file at `/public/locales/{language-code}/translation.json`:

```bash
mkdir -p public/locales/fr
touch public/locales/fr/translation.json
```

### Step 3: Add Translations

Copy the structure from `public/locales/en/translation.json` and translate all strings:

```json
{
  "common": {
    "appName": "Git Visualizer",
    "loading": "Chargement...",
    "error": "Erreur",
    ...
  },
  "navigation": {
    "home": "Accueil",
    "settings": "Paramètres",
    ...
  },
  ...
}
```

**Important:**
- Keep the same JSON structure as English
- Translate values, not keys
- Preserve placeholders like `{{variable}}`
- Keep HTML tags intact (e.g., `<strong>`, `<code>`)

### Step 4: Update Tutorial Content Mapping

If you have tutorial levels, update the locale mapping in `src/lib/i18n/hooks.ts`:

```typescript
const localeMap: Record<string, string> = {
  en: 'en_US',
  de: 'de_DE',
  ar: 'ar_SA',
  // Add your language:
  fr: 'fr_FR',
  he: 'he_IL',
};
```

Then update your level JSON files to include the new locale.

## Using Translations in Components

### Basic Usage

```typescript
import { useTranslation } from '@/lib/i18n';

function MyComponent() {
  const { t } = useTranslation();
  
  return (
    <div>
      <h1>{t('common.appName')}</h1>
      <p>{t('home.tagline')}</p>
    </div>
  );
}
```

### Nested Keys

Translation keys support dot notation for nested objects:

```typescript
// From translation.json:
// {
//   "home": {
//     "gettingStarted": {
//       "title": "Getting Started"
//     }
//   }
// }

const title = t('home.gettingStarted.title');
```

### With Interpolation

```typescript
// In translation.json:
// "welcome": "Welcome, {{name}}!"

const greeting = t('welcome', { name: 'Alice' });
// Result: "Welcome, Alice!"
```

### Pluralization

```typescript
// In translation.json:
// "items": "{{count}} item",
// "items_other": "{{count}} items"

const text = t('items', { count: 5 });
// Result: "5 items"
```

## Managing Language State

### Change Language Programmatically

```typescript
import { useLanguage } from '@/lib/i18n';

function LanguageSelector() {
  const { currentLanguage, changeLanguage } = useLanguage();
  
  const handleChange = async (newLang: 'en' | 'de' | 'ar') => {
    await changeLanguage(newLang);
  };
  
  return (
    <button onClick={() => handleChange('de')}>
      Switch to German
    </button>
  );
}
```

### Get Language Information

```typescript
import { useLanguage } from '@/lib/i18n';

function LanguageInfo() {
  const { currentLanguage, currentDir, isRTL, languages } = useLanguage();
  
  return (
    <div dir={currentDir}>
      <p>Current: {languages[currentLanguage].name}</p>
      <p>Direction: {currentDir}</p>
      <p>Is RTL: {isRTL ? 'Yes' : 'No'}</p>
    </div>
  );
}
```

## Translating Tutorial Levels

Tutorial levels use a different format with explicit locale keys like `en_US`, `de_DE`, etc.

### Level Structure

```json
{
  "id": "intro1",
  "name": {
    "en_US": "Introduction to Commits",
    "de_DE": "Einführung in Commits",
    "fr_FR": "Introduction aux Commits"
  },
  "description": {
    "en_US": "Learn how to make your first commit",
    "de_DE": "Lerne, wie man den ersten Commit erstellt",
    "fr_FR": "Apprenez à faire votre premier commit"
  },
  "tutorialSteps": [
    {
      "type": "dialog",
      "title": {
        "en_US": "Welcome to Git!",
        "de_DE": "Willkommen bei Git!",
        "fr_FR": "Bienvenue sur Git!"
      },
      "content": {
        "en_US": ["Line 1", "Line 2"],
        "de_DE": ["Zeile 1", "Zeile 2"],
        "fr_FR": ["Ligne 1", "Ligne 2"]
      }
    }
  ]
}
```

### Using Localized Content

```typescript
import { useLocalizedContent } from '@/lib/i18n';

function TutorialTitle({ level }) {
  const title = useLocalizedContent(level.name);
  return <h1>{title}</h1>;
}
```

The `useLocalizedContent` hook automatically:
- Maps i18next language codes to level locale codes
- Falls back to `en_US` if translation is missing
- Handles both string and array content

## RTL Support

### Automatic Direction Handling

The `I18nProvider` automatically sets the `dir` attribute on the `<html>` element when the language changes:

- LTR languages (English, German, etc.): `dir="ltr"`
- RTL languages (Arabic, Hebrew, etc.): `dir="rtl"`

### CSS for RTL

RTL styles are defined in `src/app/globals.css`:

```css
/* Automatic direction */
[dir="rtl"] {
  direction: rtl;
}

/* Flex direction reversal */
[dir="rtl"] .flex-row {
  flex-direction: row-reverse;
}

/* Border adjustments */
[dir="rtl"] .border-l {
  border-left-width: 0;
  border-right-width: 1px;
}
```

### Component-Level RTL

For component-specific RTL handling:

```typescript
import { useLanguage } from '@/lib/i18n';

function MyComponent() {
  const { isRTL } = useLanguage();
  
  return (
    <div className={isRTL ? 'flex-row-reverse' : 'flex-row'}>
      {/* Content */}
    </div>
  );
}
```

### Testing RTL Layout

1. Switch to Arabic in settings
2. Verify no horizontal overflow
3. Check text alignment
4. Ensure icons and UI elements are mirrored appropriately

## Language Detection

The system detects language in this order:

1. **localStorage** - Saved preference from previous session
2. **Browser navigator** - Browser's language setting
3. **Query string** - `?lang=de` in URL
4. **Fallback** - English (`en`) as default

### Override via URL

You can test different languages without changing settings:

```
http://localhost:3000/?lang=de
http://localhost:3000/?lang=ar
```

## Testing

### Unit Tests

Run unit tests for i18n hooks:

```bash
pnpm test src/lib/i18n
```

### E2E Tests

Run Playwright tests for language switching and RTL:

```bash
pnpm test:e2e e2e/i18n.spec.ts
```

Test coverage includes:
- Language switching
- Preference persistence
- RTL layout
- Accessibility

## Best Practices

### 1. Always Use Translation Keys

❌ **Bad:**
```typescript
<h1>Welcome to Git Visualizer</h1>
```

✅ **Good:**
```typescript
<h1>{t('home.welcome')}</h1>
```

### 2. Provide Context in Keys

Use descriptive, hierarchical keys:

```json
{
  "button": {
    "save": "Save",
    "cancel": "Cancel",
    "submit": "Submit"
  }
}
```

### 3. Keep Translations Synchronized

When adding a new key to English, immediately add it to all other languages (even if it's just the English text as a placeholder).

### 4. Avoid Long Strings in Code

❌ **Bad:**
```json
{
  "message": "This is a very long message that explains everything about how to use this feature in great detail..."
}
```

✅ **Good:**
```json
{
  "feature": {
    "intro": "This feature helps you...",
    "usage": "To use it, follow these steps:",
    "steps": ["Step 1", "Step 2", "Step 3"]
  }
}
```

### 5. Handle RTL-Specific Issues

- Use logical properties in CSS (e.g., `margin-inline-start` instead of `margin-left`)
- Test with actual RTL languages, not just flipped English
- Avoid hardcoded directional icons (use `isRTL` to flip)

### 6. Preserve HTML Structure

When translating content with markup:

```json
{
  "description": "Click <strong>Save</strong> to continue"
}
```

Ensure translators keep the HTML tags in place.

## Troubleshooting

### Translations Not Loading

1. Check browser console for HTTP errors loading translation files
2. Verify translation file exists at `/public/locales/{lang}/translation.json`
3. Ensure JSON is valid (use a JSON validator)

### Language Not Changing

1. Check localStorage: Open DevTools → Application → Local Storage → `i18nextLng`
2. Clear localStorage and try again
3. Verify language code matches `supportedLngs` in config

### RTL Layout Issues

1. Check if `dir="rtl"` is set on `<html>`
2. Inspect CSS for conflicting direction rules
3. Use browser DevTools to debug flexbox/grid layouts
4. Test with different viewport sizes

### Missing Translations

If a key is missing, i18next returns the key itself. To debug:

1. Enable debug mode in `src/lib/i18n/config.ts`:
   ```typescript
   debug: true
   ```
2. Check console for "key not found" warnings
3. Verify key path is correct in translation file

## Additional Resources

- [i18next Documentation](https://www.i18next.com/)
- [react-i18next Documentation](https://react.i18next.com/)
- [W3C Internationalization](https://www.w3.org/International/)
- [RTL Styling Guidelines](https://rtlstyling.com/)

## Contributing

When contributing translations:

1. Follow the existing JSON structure
2. Use native language names in the `languages` object
3. Test with actual native speakers when possible
4. Run tests to ensure no regressions
5. Include screenshots in PRs for visual changes

For questions or issues, please open a GitHub issue with the `i18n` label.
